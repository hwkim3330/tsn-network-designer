<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Textured Mesh TSN Viewer – All-in-One</title>

<!-- three.js r128 (요청 코드 호환 유지) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root{
    --blue:#0066FF; --cyan:#00BCD4; --ink:#0f0c29; --ink2:#302b63; --ink3:#24243e;
    --glow: rgba(0,102,255,.3); --bg: linear-gradient(135deg,var(--ink) 0%,var(--ink2) 50%,var(--ink3) 100%);
  }
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:#eee;overflow:hidden}
  a{color:var(--cyan);text-decoration:none}
  .app{display:flex;flex-direction:column;height:100vh}
  .header{
    height:84px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);
    border-bottom:2px solid var(--blue);display:flex;align-items:center;justify-content:space-between;
    padding:0 16px 0 24px;box-shadow:0 4px 24px var(--glow);z-index:50;gap:12px
  }
  .header-left{display:flex;align-items:center;gap:16px}
  .logo{height:44px;width:auto}
  .title-group h1{
    font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--blue) 0%,var(--cyan) 100%);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent
  }
  .title-group p{font-size:12px;color:#aaa}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{
    padding:10px 14px;border-radius:10px;border:2px solid var(--blue);font-weight:700;cursor:pointer;
    font-size:13px;background:rgba(0,102,255,.15);color:var(--cyan);transition:.2s;backdrop-filter:blur(10px)
  }
  .btn:hover{background:rgba(0,102,255,.35);border-color:var(--cyan);transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(0,188,212,.35)}
  .btn.active{background:var(--blue);color:#fff;border-color:var(--blue)}
  .sep{width:1px;height:28px;background:rgba(255,255,255,.1);margin:0 6px}
  .canvas{flex:1;position:relative}
  #canvas3d{width:100%;height:100%}

  .panel{position:absolute;background:rgba(0,0,0,.88);backdrop-filter:blur(18px);border:2px solid var(--blue);
    border-radius:12px;box-shadow:0 8px 32px var(--glow)}
  .info-panel{top:16px;right:16px;min-width:320px;padding:18px}
  .legend{bottom:16px;left:16px;padding:16px}
  .help-text{bottom:16px;right:16px;padding:12px 16px;border:1px solid rgba(0,102,255,.6);color:var(--cyan)}
  .help-text,.legend,.info-panel{font-size:13px}
  .legend-title,.info-title{font-size:14px;font-weight:900;color:var(--cyan);margin-bottom:10px;letter-spacing:.5px;text-transform:uppercase}
  .legend-item{display:flex;align-items:center;gap:10px;margin:6px 0;color:#ddd}
  .legend-color{width:22px;height:22px;border-radius:4px;border:1px solid rgba(255,255,255,.35);box-shadow:0 2px 8px rgba(0,0,0,.3)}

  .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#fff;font-size:20px;font-weight:800;z-index:20}
  .loading-bar{width:300px;height:6px;background:rgba(255,255,255,.2);border-radius:3px;margin-top:16px;overflow:hidden}
  .loading-progress{height:100%;background:linear-gradient(90deg,var(--blue) 0%,var(--cyan) 100%);width:0%}

  .toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:rgba(0,102,255,.95);
    color:#fff;padding:14px 22px;border-radius:9px;font-weight:800;opacity:0;transition:opacity .25s;z-index:1000;
    border:2px solid var(--cyan);box-shadow:0 4px 24px rgba(0,188,212,.5)}
  .toast.visible{opacity:1}

  .upload-zone{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#fff;
    border:3px dashed var(--blue);padding:42px;border-radius:16px;background:rgba(0,0,0,.9)}
  .upload-zone h2{font-size:24px;margin-bottom:10px;background:linear-gradient(135deg,var(--blue) 0%,var(--cyan) 100%);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .upload-zone p{font-size:14px;color:#bbb;margin-bottom:18px}
  .upload-btn{background:var(--blue);color:#fff;padding:14px 26px;border-radius:8px;border:none;font-weight:800;cursor:pointer}
  .upload-btn:hover{background:#0052CC;transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,102,255,.4)}
  .model-info{margin-top:18px;padding-top:18px;border-top:1px solid rgba(0,102,255,.3);font-size:12px;color:#999}

  .parts-panel{top:16px;left:16px;padding:16px;max-height:78vh;overflow:auto;display:none;min-width:280px}
  .parts-panel.visible{display:block}
  .parts-title{font-size:14px;color:var(--cyan);font-weight:900;margin-bottom:10px}
  .part-item{display:flex;align-items:center;justify-content:space-between;padding:9px;margin-bottom:8px;background:rgba(0,102,255,.1);border-radius:7px;cursor:pointer}
  .part-item:hover{background:rgba(0,102,255,.2)}
  .part-item.hidden{opacity:.55;background:rgba(255,0,0,.08)}
  .part-toggle{width:40px;height:20px;background:#666;border-radius:10px;position:relative}
  .part-toggle::after{content:'';position:absolute;width:16px;height:16px;background:white;border-radius:50%;top:2px;left:2px;transition:left .2s}
  .part-toggle.active{background:var(--blue)}
  .part-toggle.active::after{left:22px}

  .add-panel{bottom:16px;left:50%;transform:translateX(-50%);padding:14px;display:none;gap:10px}
  .add-panel.visible{display:flex}
  .add-btn{padding:10px 14px;border-radius:8px;border:2px solid;background:rgba(0,0,0,.5);color:#fff;font-weight:800;cursor:pointer}
  .add-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,188,212,.35)}

  .right-drawer{position:absolute;top:108px;right:16px;width:420px;max-height:80vh;overflow:auto;padding:16px;display:none}
  .right-drawer.visible{display:block}
  .drawer-title{font-size:15px;font-weight:900;color:var(--cyan);margin-bottom:10px}
  .field{display:flex;gap:8px;align-items:center;margin:6px 0}
  input[type="number"],input[type="text"],select,textarea{
    background:#0b0b0b;border:1px solid rgba(255,255,255,.15);color:#eee;border-radius:8px;padding:8px;font-size:13px;width:100%
  }
  textarea{min-height:80px;resize:vertical}
  .subtle{font-size:12px;color:#aaa}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .pill{display:inline-block;padding:2px 8px;border:1px solid rgba(255,255,255,.2);border-radius:999px;font-size:12px;color:#ccc}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0b0b;border:1px solid rgba(255,255,255,.2);padding:2px 6px;border-radius:6px}
  .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0b0b;border:1px solid rgba(255,255,255,.2);padding:10px;border-radius:10px;white-space:pre-wrap}

  .mini-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px;margin-top:8px}
  .mini-grid div{height:10px;border-radius:2px;background:#1a1a1a;border:1px solid rgba(255,255,255,.08)}
  .mini-grid div.on{background:#19c37d}

  .toolbar{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .toolbar .btn{padding:8px 10px;font-size:12px}
  .opacity-wrap{display:flex;align-items:center;gap:8px}
  .opacity-wrap input[type="range"]{width:140px}

  /* 폴백 오버레이 이미지 */
  .overlay-img{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);opacity:.9;display:none;pointer-events:none}
  .switch-cards{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
  .card{border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;background:rgba(255,255,255,.03)}
  .card h4{margin-bottom:6px}
  canvas#tasCanvas{width:100%;height:120px;background:#0b0b0b;border:1px solid rgba(255,255,255,.1);border-radius:8px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="header-left">
      <img src="keti.png" alt="KETI" class="logo" onerror="this.style.display='none'">
      <div class="title-group">
        <h1>Textured Mesh TSN Viewer</h1>
        <p>3D Vehicle Model with TSN Integration</p>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="uploadBtn">📁 Load Model</button>
      <button class="btn" id="partSelector">🔧 Body Parts</button>
      <button class="btn" id="addComponent">➕ Add TSN</button>
      <button class="btn" id="autoLayout">📐 Auto Layout</button>
      <button class="btn" id="dragMode">🖱️ Drag Mode</button>
      <button class="btn" id="autoRotate">🔄 Auto Rotate</button>
      <button class="btn" id="toggleTSN">Show TSN</button>
      <span class="sep"></span>
      <button class="btn" id="toggleConfig">🧩 TSN Config</button>
      <button class="btn" id="toggleProfiles">💾 Profiles</button>
      <span class="sep"></span>
      <button class="btn" id="xrayBtn">🩻 X‑Ray</button>
      <div class="opacity-wrap">
        <label class="subtle">Opacity</label>
        <input id="opacitySlider" type="range" min="0" max="1" step="0.05" value="1">
      </div>
    </div>
  </div>

  <div class="canvas">
    <div id="canvas3d"></div>

    <!-- 로딩 -->
    <div class="loading" id="loading" style="display:none;">
      <div>Loading 3D Model...</div>
      <div class="loading-bar"><div class="loading-progress" id="loadingProgress"></div></div>
    </div>

    <!-- 업로드 -->
    <div class="upload-zone" id="uploadZone">
      <h2>🚗 Load Your 3D Model</h2>
      <p>Upload a GLB or GLTF file to visualize TSN integration</p>
      <input type="file" id="fileInput" accept=".glb,.gltf" hidden>
      <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
      <div class="model-info">
        <strong>Supported:</strong> GLB, GLTF<br>
        <strong>Default:</strong> <code>textured_mesh.glb</code><br>
        <strong>Free Models:</strong> <a href="https://sketchfab.com" target="_blank">Sketchfab</a>
      </div>
    </div>

    <!-- 정보 -->
    <div class="panel info-panel" id="infoPanel" style="display:none;">
      <div class="info-title">TSN Network Status</div>
      <div class="field"><span class="subtle">Vehicle Model</span><span style="margin-left:auto" id="modelName" class="pill">—</span></div>
      <div class="field"><span class="subtle">Main Gateway</span><span style="margin-left:auto" class="pill">LAN9692 (10G)</span></div>
      <div class="field"><span class="subtle">Zone Controllers</span><span style="margin-left:auto" class="pill">3× LAN9662</span></div>
      <div class="field"><span class="subtle">Sensors Active</span><span style="margin-left:auto" class="pill" id="sensorCount">—</span></div>
      <div class="field"><span class="subtle">Network Health</span><span style="margin-left:auto" class="pill">✓ Optimal</span></div>
      <div class="switch-cards" id="switchCards"></div>
    </div>

    <!-- 범례 -->
    <div class="panel legend" id="legend" style="display:none;">
      <div class="legend-title">TSN Components</div>
      <div class="legend-item"><div class="legend-color" style="background:#00C853"></div><span>LAN9692 Gateway</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#0066FF"></div><span>LAN9662 Zone Ctrl</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#FFD700"></div><span>10G SFP+ Uplink</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#00BCD4"></div><span>Camera (T1)</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#FF9800"></div><span>Radar (T1)</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#9C27B0"></div><span>LiDAR (T1)</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#4CAF50"></div><span>Ultrasonic (Parking)</span></div>
      <div class="legend-item"><div class="legend-color" style="background:#E91E63"></div><span>Dashboard Display</span></div>
    </div>

    <!-- 헬프 -->
    <div class="panel help-text">
      <strong>Camera:</strong> Left Drag = Rotate · Right Drag = Pan · Scroll = Zoom
    </div>

    <!-- 파트 -->
    <div class="panel parts-panel" id="partsPanel">
      <div class="parts-title">Car Body Parts</div>
      <div id="partsList"></div>
    </div>

    <!-- 추가 패널 -->
    <div class="panel add-panel" id="addPanel">
      <button class="add-btn" style="border-color:#00C853;color:#00C853" onclick="addTSNComponent('gateway')">Gateway</button>
      <button class="add-btn" style="border-color:#0066FF;color:#0066FF" onclick="addTSNComponent('zone')">Zone Ctrl</button>
      <button class="add-btn" style="border-color:#00BCD4;color:#00BCD4" onclick="addTSNComponent('camera')">Camera</button>
      <button class="add-btn" style="border-color:#FF9800;color:#FF9800" onclick="addTSNComponent('radar')">Radar</button>
      <button class="add-btn" style="border-color:#9C27B0;color:#9C27B0" onclick="addTSNComponent('lidar')">LiDAR</button>
      <button class="add-btn" style="border-color:#4CAF50;color:#4CAF50" onclick="addTSNComponent('ultrasonic')">Ultrasonic</button>
    </div>

    <!-- TSN 설정 드로어 -->
    <div class="panel right-drawer" id="configDrawer">
      <div class="drawer-title">TSN Configuration</div>

      <!-- PTP -->
      <h3 class="info-title">PTP / gPTP</h3>
      <div class="row">
        <div class="field">
          <label class="subtle">Profile</label>
          <select id="ptpProfile">
            <option value="gptp">gPTP (802.1AS)</option>
            <option value="auto-bridge">Automotive Bridge</option>
            <option value="auto-gm">Automotive Grandmaster</option>
            <option value="off">Off</option>
          </select>
        </div>
        <div class="field">
          <label class="subtle">Servo</label>
          <select id="ptpServo">
            <option value="pi">PI</option>
            <option value="off">Off</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="field"><label class="subtle">Instance Index</label><input id="ptpInstance" type="number" value="0" min="0"></div>
        <div class="field"><label class="subtle">LTC Index</label><input id="ptpLtc" type="number" value="0" min="0"></div>
      </div>
      <div class="row">
        <div class="field"><label class="subtle">Port A Index</label><input id="ptpPortA" type="number" value="25" min="0"></div>
        <div class="field"><label class="subtle">Port B Index</label><input id="ptpPortB" type="number" value="26" min="0"></div>
      </div>
      <div class="toolbar">
        <button class="btn" id="genPtp">⎘ Generate iPATCH</button>
        <button class="btn" id="copyPtp">📋 Copy</button>
      </div>
      <pre class="code" id="ptpOut"></pre>

      <!-- TAS -->
      <h3 class="info-title" style="margin-top:12px;">TAS (802.1Qbv)</h3>
      <div class="row">
        <div class="field"><label class="subtle">Interface Name</label><input id="tasIfName" value="1"></div>
        <div class="field"><label class="subtle">Base Time (s)</label><input id="tasBaseSec" type="number" value="20"></div>
        <div class="field"><label class="subtle">Base Time (ns)</label><input id="tasBaseNsec" type="number" value="0"></div>
      </div>
      <div class="row">
        <div class="field"><label class="subtle">Cycle Numerator (ns)</label><input id="tasCycleNum" type="number" value="140000000"></div>
        <div class="field"><label class="subtle">Cycle Denominator</label><input id="tasCycleDen" type="number" value="1000000000"></div>
        <div class="field"><label class="subtle">Cycle Ext(ns)</label><input id="tasCycleExt" type="number" value="10000000"></div>
      </div>
      <div class="subtle">Gate Control List Entries</div>
      <div class="row">
        <div class="field"><input id="tasIdx" type="number" value="1" min="1" placeholder="Index"></div>
        <div class="field"><input id="tasInterval" type="number" value="10000000" min="1" placeholder="Interval(ns)"></div>
        <div class="field"><input id="tasGateStates" type="number" value="1" min="0" max="255" placeholder="GateStates (bitmask)"></div>
      </div>
      <div class="toolbar">
        <button class="btn" id="addTasEntry">➕ Add Entry</button>
        <button class="btn" id="clearTas">🧹 Clear</button>
        <button class="btn" id="genTas">⎘ Generate iPATCH</button>
        <button class="btn" id="copyTas">📋 Copy</button>
      </div>
      <div id="tasList" class="subtle"></div>
      <canvas id="tasCanvas"></canvas>
      <pre class="code" id="tasOut"></pre>

      <!-- PSFP -->
      <h3 class="info-title" style="margin-top:12px;">PSFP (802.1Qci)</h3>
      <div class="row">
        <div class="field"><label class="subtle">Stream ID</label><input id="psfpStreamId" type="number" value="1" min="1"></div>
        <div class="field"><label class="subtle">Handle</label><input id="psfpHandle" type="number" value="2" min="1"></div>
      </div>
      <div class="row">
        <div class="field"><label class="subtle">Ingress Port</label><input id="psfpInPort" type="text" value="1"></div>
        <div class="field"><label class="subtle">DMAC</label><input id="psfpDmac" type="text" value="01-02-03-04-05-06"></div>
      </div>
      <div class="row">
        <div class="field"><label class="subtle">Filter ID</label><input id="psfpFilterId" type="number" value="1" min="1"></div>
        <div class="field"><label class="subtle">Max SDU</label><input id="psfpMaxSdu" type="number" value="1024" min="0"></div>
      </div>
      <div class="row">
        <div class="field"><label class="subtle">Gate Ref</label><input id="psfpGateRef" type="number" value="1" min="0"></div>
        <div class="field"><label class="subtle">Meter Ref</label><input id="psfpMeterRef" type="number" value="1" min="0"></div>
      </div>
      <div class="toolbar">
        <button class="btn" id="genPsfp">⎘ Generate iPATCH</button>
        <button class="btn" id="copyPsfp">📋 Copy</button>
      </div>
      <pre class="code" id="psfpOut"></pre>
    </div>

    <!-- 프로파일 드로어 -->
    <div class="panel right-drawer" id="profileDrawer" style="right:446px;">
      <div class="drawer-title">Profiles</div>
      <div class="field">
        <label class="subtle">Active Profile</label>
        <select id="profileSelect"></select>
      </div>
      <div class="toolbar">
        <button class="btn" id="saveProfile">💾 Save</button>
        <button class="btn" id="saveAsProfile">📝 Save As…</button>
        <button class="btn" id="deleteProfile">🗑️ Delete</button>
      </div>
      <div class="toolbar">
        <button class="btn" id="exportProfile">⤴️ Export JSON</button>
        <label class="btn" for="importFile" style="cursor:pointer;">⤵️ Import JSON</label>
        <input id="importFile" type="file" accept=".json,application/json" hidden>
      </div>
      <div class="subtle" style="margin-top:8px;">
        - 위치/가시성/TSN 구성(PTP/TAS/PSFP)과 장치 카드까지 저장됩니다.<br>
        - 브라우저 <span class="kbd">localStorage</span>에 보관됩니다.
      </div>
      <pre class="code" id="profilePreview" style="margin-top:8px;"></pre>
    </div>

    <!-- 폴백 오버레이 이미지 (3D 텍스처 로딩 실패 시 표시) -->
    <img id="overlayFallback" class="overlay-img" src="https://cdn.imweb.me/upload/S202309086909876845cbd/664c5f6826b0b.png" alt="overlay">

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   Scene setup
   ========================= */
const container = document.getElementById('canvas3d');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xe0e0e0);
scene.fog = new THREE.Fog(0xe0e0e0, 50, 120);

const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
camera.position.set(8, 4, 12);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 2.0;
renderer.outputEncoding = THREE.sRGBEncoding;
container.appendChild(renderer.domElement);

function updateSize(){
  const w = container.clientWidth, h = container.clientHeight || window.innerHeight - 120;
  camera.aspect = w / h; camera.updateProjectionMatrix(); renderer.setSize(w, h);
}
updateSize(); window.addEventListener('resize', updateSize);

/* Controls */
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.05;
controls.minDistance = 3; controls.maxDistance = 40; controls.maxPolarAngle = Math.PI/1.5;
controls.autoRotate = false; controls.autoRotateSpeed = 1.0;

/* Lighting */
const ambientLight = new THREE.AmbientLight(0xffffff, 2.0); scene.add(ambientLight);
const mainLight = new THREE.DirectionalLight(0xffffff, 2.5);
mainLight.position.set(10, 15, 10); mainLight.castShadow = true;
mainLight.shadow.mapSize.set(2048,2048);
mainLight.shadow.camera.near = .5; mainLight.shadow.camera.far = 50;
mainLight.shadow.camera.left = -15; mainLight.shadow.camera.right = 15;
mainLight.shadow.camera.top = 15; mainLight.shadow.camera.bottom = -15;
scene.add(mainLight);
scene.add(new THREE.DirectionalLight(0xffffff, 1.5)).position.set(-10,8,-10);
scene.add(new THREE.DirectionalLight(0xffffff, 1.0)).position.set(0,5,-15);
scene.add(new THREE.DirectionalLight(0xffffff, 1.2)).position.set(0,20,0);
scene.add(new THREE.DirectionalLight(0xffffff, 0.8)).position.set(-15,3,0);
scene.add(new THREE.DirectionalLight(0xffffff, 0.8)).position.set(15,3,0);

/* Ground & Grid */
const ground = new THREE.Mesh(new THREE.CircleGeometry(50,64),
  new THREE.MeshStandardMaterial({ color:0xf5f5f5, roughness:.9, metalness:.1 }));
ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);
const gridHelper = new THREE.PolarGridHelper(20,16,8,64,0x0066FF,0xcccccc);
gridHelper.material.opacity = .5; gridHelper.material.transparent = true; scene.add(gridHelper);

/* Models & groups */
let carModel = null;
let tsnGroup = new THREE.Group(); tsnGroup.visible = false; scene.add(tsnGroup);
let tsnVisible = false, dragMode = false, selectedTSNComponent = null;
let tsnConnections = [];
const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();

/* Overlay image as textured plane */
let overlayPlane = null;
function addOverlayPlane(){
  const url = "https://cdn.imweb.me/upload/S202309086909876845cbd/664c5f6826b0b.png";
  const loader = new THREE.TextureLoader();
  loader.setCrossOrigin('anonymous');
  loader.load(url, (tex)=>{
    const ar = tex.image.width/tex.image.height;
    const w = 2.8, h = w/ar;
    const geo = new THREE.PlaneGeometry(w, h);
    const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, opacity: 0.9 });
    overlayPlane = new THREE.Mesh(geo, mat);
    overlayPlane.position.set(-3.5, 3.2, 0);
    overlayPlane.rotation.y = Math.PI * -0.1;
    overlayPlane.userData.tsnType = 'overlay';
    scene.add(overlayPlane);
  }, undefined, ()=>{
    // fallback to DOM overlay
    document.getElementById('overlayFallback').style.display = 'block';
  });
}
addOverlayPlane();

/* Device catalog (summary for info cards) */
const deviceCatalog = {
  LAN9692: {
    name:"LAN9692", color:0x00C853,
    summary:"66G Automotive TSN Switch, 최대 30포트 / 10M~10G, 10G 업링크 가능",
    bullets:[
      "TAS(Qbv), PSFP(Qci), CBS(Qav), Frame Preemption(Qbu), gPTP(802.1AS)",
      "YANG/CORECONF 기반 VelocityDRIVE‑SP 관리",
    ]
  },
  LAN9662: {
    name:"LAN9662", color:0x0066FF,
    summary:"4‑Port TSN Gigabit Switch with Cortex‑A7 & Real‑Time Engine",
    bullets:[
      "통합 PHY(최대 2), RGMII/RMII/SGMII 등",
      "PTP/TAS/PSFP 등 TSN 스택 연동"
    ]
  }
};

/* UI helpers */
const $ = (id)=>document.getElementById(id);
function showToast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'), 2200); }

/* =========================
   TSN components (3D)
   ========================= */
function createTSNBoard(color, label, scale=1){
  const g = new THREE.Group(); g.userData.tsnType='board'; g.userData.label=label; g.userData.draggable = true;
  const board = new THREE.Mesh(new THREE.BoxGeometry(.3*scale,.02*scale,.2*scale),
    new THREE.MeshStandardMaterial({ color:0x2a5f2a, roughness:.6, metalness:.4 }));
  board.castShadow=true; g.add(board);
  const chip = new THREE.Mesh(new THREE.BoxGeometry(.12*scale,.04*scale,.08*scale),
    new THREE.MeshStandardMaterial({ color, roughness:.2, metalness:.8, emissive:color, emissiveIntensity:.5 }));
  chip.position.y = .03*scale; g.add(chip);
  const glow = new THREE.Mesh(new THREE.SphereGeometry(.08*scale, 16, 16),
    new THREE.MeshBasicMaterial({ color, transparent:true, opacity:.3 }));
  glow.position.copy(chip.position); g.add(glow);
  return g;
}

function createSensor(color, scale=1){
  const g = new THREE.Group(); g.userData.tsnType = 'sensor'; g.userData.draggable = true;
  const m = new THREE.Mesh(new THREE.CylinderGeometry(.06*scale,.06*scale,.12*scale,16),
    new THREE.MeshStandardMaterial({ color, roughness:.3, metalness:.7, emissive:color, emissiveIntensity:.3 }));
  m.castShadow = true; g.add(m); return g;
}

function createConnection(from, to, color=0xFFD700){
  const geometry = new THREE.BufferGeometry().setFromPoints([from.clone(), to.clone()]);
  const material = new THREE.LineBasicMaterial({ color, linewidth:3, transparent:true, opacity:.6 });
  const line = new THREE.Line(geometry, material); line.userData.isConnection=true; return line;
}

function updateConnections(){
  tsnConnections.forEach(c=>scene.remove(c)); tsnConnections.length=0;
  if(!tsnVisible) return;
  const comps = tsnGroup.children.filter(c=>c.userData.tsnType);
  for(let i=0;i<comps.length-1;i++){
    const conn = createConnection(comps[i].position, comps[i+1].position, 0xFFD700);
    scene.add(conn); tsnConnections.push(conn);
  }
}

function setupTSNComponents(){
  tsnGroup.clear();
  if(!carModel){ updateConnections(); return; }

  /* Car bbox */
  const bbox = new THREE.Box3().setFromObject(carModel);
  const size = new THREE.Vector3(); bbox.getSize(size);
  const center = new THREE.Vector3(); bbox.getCenter(center);

  /* Gateway & Zones */
  const gw = createTSNBoard(0x00C853,'LAN9692 Gateway', 3);
  gw.position.set(center.x - size.x*0.38, center.y+0.30, center.z); gw.userData.device='LAN9692'; tsnGroup.add(gw);

  const z1 = createTSNBoard(0x0066FF,'Zone 1',2.5); z1.position.set(center.x + size.x*0.42, center.y+0.2, center.z); z1.userData.device='LAN9662'; tsnGroup.add(z1);
  const z2 = createTSNBoard(0x0066FF,'Zone 2',2.5); z2.position.set(center.x + size.x*0.10, center.y+0.2, center.z - size.z*0.5); z2.userData.device='LAN9662'; tsnGroup.add(z2);
  const z3 = createTSNBoard(0x0066FF,'Zone 3',2.5); z3.position.set(center.x + size.x*0.10, center.y+0.2, center.z + size.z*0.5); z3.userData.device='LAN9662'; tsnGroup.add(z3);

  /* Sensors */
  const addS=(obj)=>{ tsnGroup.add(obj); };
  let count=0;
  const cL = createSensor(0x00BCD4,2); cL.position.set(center.x + size.x*.5, center.y + size.y*.15, center.z - size.z*.2); cL.userData.label='Front Cam L'; addS(cL); count++;
  const cR = createSensor(0x00BCD4,2); cR.position.set(center.x + size.x*.5, center.y + size.y*.15, center.z + size.z*.2); cR.userData.label='Front Cam R'; addS(cR); count++;
  const cS1= createSensor(0x00BCD4,2); cS1.position.set(center.x + size.x*.05, center.y + size.y*.2, center.z - size.z*.52); cS1.userData.label='Left Cam'; addS(cS1); count++;
  const cS2= createSensor(0x00BCD4,2); cS2.position.set(center.x + size.x*.05, center.y + size.y*.2, center.z + size.z*.52); cS2.userData.label='Right Cam'; addS(cS2); count++;
  const cRear=createSensor(0x00BCD4,2); cRear.position.set(center.x - size.x*.5, center.y + size.y*.1, center.z); cRear.userData.label='Rear Cam'; addS(cRear); count++;

  const rF = createSensor(0xFF9800,2.5); rF.position.set(center.x + size.x*.52, center.y+.3, center.z); rF.userData.label='Front Radar'; addS(rF); count++;
  const rFL= createSensor(0xFF9800,1.8); rFL.position.set(center.x + size.x*.48, center.y+.15, center.z - size.z*.4); rFL.userData.label='Corner Radar FL'; addS(rFL); count++;
  const rFR= createSensor(0xFF9800,1.8); rFR.position.set(center.x + size.x*.48, center.y+.15, center.z + size.z*.4); rFR.userData.label='Corner Radar FR'; addS(rFR); count++;

  const lidar = createSensor(0x9C27B0,2.5); lidar.position.set(center.x + size.x*.2, center.y + size.y*.52, center.z); lidar.userData.label='LiDAR'; addS(lidar); count++;

  const ulPos = [
    [center.x + size.x*.5, center.y - size.y*.35, center.z - size.z*.35],
    [center.x + size.x*.5, center.y - size.y*.35, center.z + size.z*.35],
    [center.x - size.x*.5, center.y - size.y*.35, center.z - size.z*.35],
    [center.x - size.x*.5, center.y - size.y*.35, center.z + size.z*.35],
  ];
  ulPos.forEach((p,i)=>{ const u=createSensor(0x4CAF50,1.2); u.position.set(...p); u.userData.label=`Ultrasonic ${i+1}`; addS(u); count++; });

  /* Dashboard */
  const dash = createTSNBoard(0xE91E63,'Display',2); dash.position.set(center.x + size.x*.15, center.y+.5, center.z); dash.userData.label='Dashboard Display'; tsnGroup.add(dash);

  $('sensorCount').innerText = `${count} Devices`;
  tsnGroup.visible = tsnVisible;
  updateConnections();
  renderSwitchCards();
}

/* Switch cards on info panel */
function renderSwitchCards(){
  const el = $('switchCards'); el.innerHTML = '';
  const deviceCount = {};
  tsnGroup.children.forEach(c=>{
    const d = c.userData.device;
    if(d){ deviceCount[d] = (deviceCount[d]||0)+1; }
  });
  Object.keys(deviceCatalog).forEach(k=>{
    const n = deviceCount[k]||0; if(n===0) return;
    const d = deviceCatalog[k];
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<h4>${d.name} <span class="pill">${n}x</span></h4>
      <div class="subtle">${d.summary}</div>
      <ul class="subtle" style="margin-top:6px;padding-left:18px">
        ${d.bullets.map(b=>`<li>${b}</li>`).join('')}
      </ul>`;
    el.appendChild(card);
  });
}

/* =========================
   Body parts
   ========================= */
let bodyParts = [];
function analyzeBodyParts(){
  if(!carModel) return;
  bodyParts = []; const list = $('partsList'); list.innerHTML='';
  const nameSet = new Set();
  carModel.traverse(node=>{
    if(node.isMesh && node.name && !nameSet.has(node.name)){
      nameSet.add(node.name);
      bodyParts.push({ name:node.name, visible:true });
      const item=document.createElement('div'); item.className='part-item';
      item.innerHTML = `<span class="part-name">${node.name}</span><div class="part-toggle active" data-part="${node.name}"></div>`;
      item.addEventListener('click', ()=>toggleBodyPart(node.name));
      list.appendChild(item);
    }
  });
}

function toggleBodyPart(name){
  if(!carModel) return;
  let visibleNow = true;
  carModel.traverse(n=>{
    if(n.isMesh && n.name===name){
      n.visible = !n.visible; visibleNow = n.visible;
    }
  });
  const toggle = document.querySelector(`[data-part="${name}"]`);
  const item = toggle.parentElement;
  if(visibleNow){ toggle.classList.add('active'); item.classList.remove('hidden'); }
  else { toggle.classList.remove('active'); item.classList.add('hidden'); }
}

/* =========================
   Add TSN component
   ========================= */
function addTSNComponent(type){
  const bbox = carModel ? new THREE.Box3().setFromObject(carModel) : new THREE.Box3();
  const center = new THREE.Vector3(); bbox.getCenter(center);
  let c;
  switch(type){
    case 'gateway': c = createTSNBoard(0x00C853,'Gateway',3); c.userData.device='LAN9692'; break;
    case 'zone': c = createTSNBoard(0x0066FF,'Zone',2.5); c.userData.device='LAN9662'; break;
    case 'camera': c = createSensor(0x00BCD4,2); c.userData.label='Camera'; break;
    case 'radar': c = createSensor(0xFF9800,2); c.userData.label='Radar'; break;
    case 'lidar': c = createSensor(0x9C27B0,2.5); c.userData.label='LiDAR'; break;
    case 'ultrasonic': c = createSensor(0x4CAF50,1.2); c.userData.label='Ultrasonic'; break;
  }
  c.position.set(center.x, center.y+1, center.z);
  tsnGroup.add(c); updateConnections(); renderSwitchCards();
  showToast(`Added ${type} component`);
}

/* =========================
   Drag
   ========================= */
let isDragging=false, dragPlane=new THREE.Plane(), dragOffset=new THREE.Vector3(), dragIntersection=new THREE.Vector3();
function onMouseDown(e){
  if(!dragMode || !tsnVisible) return;
  mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
  mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const inter = raycaster.intersectObjects(tsnGroup.children, true);
  if(inter.length>0){
    let sel = inter[0].object; while(sel.parent && sel.parent!==tsnGroup) sel = sel.parent;
    if(sel.userData.draggable){
      selectedTSNComponent=sel; isDragging=true; controls.enabled=false;
      dragPlane.setFromNormalAndCoplanarPoint(camera.getWorldDirection(dragPlane.normal), sel.position);
      raycaster.ray.intersectPlane(dragPlane, dragIntersection);
      dragOffset.copy(dragIntersection).sub(sel.position);
    }
  }
}
function onMouseMove(e){
  if(!isDragging || !selectedTSNComponent) return;
  mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
  mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  if(raycaster.ray.intersectPlane(dragPlane, dragIntersection)){
    selectedTSNComponent.position.copy(dragIntersection.sub(dragOffset));
    updateConnections();
  }
}
function onMouseUp(){ isDragging=false; selectedTSNComponent=null; if(!dragMode) controls.enabled=true; }
renderer.domElement.addEventListener('mousedown', onMouseDown);
renderer.domElement.addEventListener('mousemove', onMouseMove);
renderer.domElement.addEventListener('mouseup', onMouseUp);

/* =========================
   Loader
   ========================= */
const loader = new THREE.GLTFLoader();
function loadModel(url, fileName='Textured Mesh Vehicle'){
  $('uploadZone').style.display='none'; $('loading').style.display='block';
  loader.load(url, (gltf)=>{
    if(carModel) scene.remove(carModel); carModel = gltf.scene;

    // Scale & center
    const bbox = new THREE.Box3().setFromObject(carModel);
    const size = bbox.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x,size.y,size.z);
    const scale = 4 / (maxDim||1); carModel.scale.multiplyScalar(scale);
    bbox.setFromObject(carModel); const center = bbox.getCenter(new THREE.Vector3());
    carModel.position.sub(center); carModel.position.y += size.y*scale*.5;

    // Shadows
    carModel.traverse(n=>{
      if(n.isMesh){ n.castShadow=true; n.receiveShadow=true; }
    });

    scene.add(carModel);
    setupTSNComponents(); analyzeBodyParts();
    $('loading').style.display='none'; $('infoPanel').style.display='block'; $('legend').style.display='block';
    $('modelName').textContent=fileName;
    showToast('✓ Model Loaded');
    if(url.startsWith('blob:')) URL.revokeObjectURL(url);
    maybeRestoreOpacity();
  }, (prog)=>{
    const pct = (prog.loaded/(prog.total||prog.loaded))*100; $('loadingProgress').style.width = pct.toFixed(0)+'%';
  }, (err)=>{
    console.error(err); showToast('❌ Error loading model'); $('loading').style.display='none'; $('uploadZone').style.display='block';
  });
}

/* default attempt */
loadModel('./textured_mesh.glb','Textured Mesh Vehicle');
$('fileInput').addEventListener('change',(e)=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f); const name = f.name.replace(/\.(glb|gltf)$/i,'');
  loadModel(url, name);
});

/* =========================
   Buttons
   ========================= */
$('toggleTSN').addEventListener('click', function(){
  tsnVisible = !tsnVisible; tsnGroup.visible = tsnVisible; this.classList.toggle('active');
  this.textContent = tsnVisible ? 'Hide TSN' : 'Show TSN';
  updateConnections(); showToast(tsnVisible?'TSN ON':'TSN OFF');
});

$('partSelector').addEventListener('click', function(){
  $('partsPanel').classList.toggle('visible'); this.classList.toggle('active');
});

$('addComponent').addEventListener('click', function(){
  $('addPanel').classList.toggle('visible'); this.classList.toggle('active');
});

$('dragMode').addEventListener('click', function(){
  dragMode = !dragMode; this.classList.toggle('active');
  controls.enabled = !dragMode;
  this.textContent = dragMode ? '🖱️ Camera Mode' : '🖱️ Drag Mode';
  showToast(dragMode? 'Drag TSN Components' : 'Rotate/Pan Camera');
});

$('autoLayout').addEventListener('click', function(){ setupTSNComponents(); showToast('Auto Layout Applied'); });

$('autoRotate').addEventListener('click', function(){
  controls.autoRotate = !controls.autoRotate; this.classList.toggle('active');
  this.textContent = controls.autoRotate ? '⏸️ Stop Rotate' : '🔄 Auto Rotate';
  showToast(controls.autoRotate?'Auto Rotation ON':'Auto Rotation OFF');
});

$('uploadBtn').addEventListener('click', ()=>$('fileInput').click());

/* =========================
   Opacity / X-Ray
   ========================= */
function setModelOpacity(alpha=1.0, onlyBody=false){
  if(!carModel) return;
  carModel.traverse(node=>{
    if(node.isMesh && node.material){
      const name = (node.name||"").toLowerCase();
      const isBody = /body|car|chassis|outer|shell|door|hood|roof|bumper|fender/.test(name);
      if(onlyBody && !isBody) return;
      if(!node.userData._origMatCloned){
        node.material = node.material.clone(); node.userData._origMatCloned = true;
        node.userData._origOpacity = node.material.opacity ?? 1.0;
        node.userData._origTransparent = !!node.material.transparent;
        node.userData._origDepthWrite = node.material.depthWrite;
      }
      node.material.transparent = alpha < 1.0;
      node.material.opacity = alpha;
      node.material.depthWrite = alpha >= 1.0 ? true : false;
      node.material.needsUpdate = true;
    }
  });
}

function resetModelOpacity(){
  if(!carModel) return;
  carModel.traverse(node=>{
    if(node.isMesh && node.material && node.userData._origMatCloned){
      node.material.transparent = node.userData._origTransparent;
      node.material.opacity = node.userData._origOpacity ?? 1.0;
      node.material.depthWrite = node.userData._origDepthWrite ?? true;
      node.material.needsUpdate = true;
    }
  });
}

let xrayOn=false;
$('xrayBtn').addEventListener('click', ()=>{
  xrayOn=!xrayOn;
  if(xrayOn){ setModelOpacity(0.3, true); $('xrayBtn').classList.add('active'); }
  else { resetModelOpacity(); $('xrayBtn').classList.remove('active'); }
  showToast(xrayOn?'X‑Ray ON (body only)':'X‑Ray OFF');
});
$('opacitySlider').addEventListener('input', (e)=>{
  const a = parseFloat(e.target.value||'1'); setModelOpacity(a, false); showToast(`Opacity: ${a}`);
  saveAuto(); // 상태 지속
});
function maybeRestoreOpacity(){
  const st = loadState(); if(!st) return;
  if(st.opacity!=null){ $('opacitySlider').value = st.opacity; setModelOpacity(st.opacity, false); }
  if(st.xrayOn){ xrayOn=true; $('xrayBtn').classList.add('active'); setModelOpacity(0.3,true); }
}

/* =========================
   TSN Config (PTP/TAS/PSFP)
   ========================= */
$('toggleConfig').addEventListener('click', ()=> $('configDrawer').classList.toggle('visible'));

/* PTP */
$('genPtp').addEventListener('click', ()=>{
  const prof = $('ptpProfile').value, servo=$('ptpServo').value, inst=+$('ptpInstance').value|0, ltc=+$('ptpLtc').value|0;
  const pA=+$('ptpPortA').value|0, pB=+$('ptpPortB').value|0;
  const ops=[];
  // Base instance & ports
  ops.push({ path:'/ieee1588-ptp:ptp/instances/instance', value:{'instance-index':inst, ports:{port:[{ 'port-index':pA}, {'port-index':pB}]} }});
  if(servo!=='off'){ ops.push({ path:'/ieee1588-ptp:ptp/instances/instance/mchp-velocitysp-ptp:servos/servo',
    value:{'servo-index':0,'servo-type':'pi','ltc-index':ltc}}); }
  if(prof==='auto-bridge'){
    ops.push({ path:'/ieee1588-ptp:ptp/instances/instance/default-ds/external-port-config-enable', value:true});
    ops.push({ path:`/ieee1588-ptp:ptp/instances/instance/ports/port[port-index='${pA}']/external-port-config-port-ds/desired-state`, value:'slave'});
    ops.push({ path:`/ieee1588-ptp:ptp/instances/instance/ports/port[port-index='${pB}']/external-port-config-port-ds/desired-state`, value:'master'});
    ops.push({ path:'/ieee1588-ptp:ptp/instances/instance/mchp-velocitysp-ptp:automotive/profile', value:'bridge' });
  }else if(prof==='auto-gm'){
    ops.push({ path:'/ieee1588-ptp:ptp/instances/instance/mchp-velocitysp-ptp:automotive/profile', value:'grandmaster' });
  }
  $('ptpOut').textContent = JSON.stringify({ iPATCH: ops }, null, 2);
  saveAuto();
});
$('copyPtp').addEventListener('click', ()=>copyText($('ptpOut').textContent));

/* TAS (entries builder) */
const tasEntries = [];
function refreshTasList(){
  const l = $('tasList');
  if(tasEntries.length===0){ l.innerHTML = '<div class="subtle">No entries yet.</div>'; }
  else{
    l.innerHTML = tasEntries.map(e=>`#${e.index} interval=${e.interval}ns gates=${e.gateStates}`).join('\n');
  }
  drawTas();
}
$('addTasEntry').addEventListener('click', ()=>{
  const idx=+$('tasIdx').value|0, iv=+$('tasInterval').value|0, gs=+$('tasGateStates').value|0;
  if(!idx || !iv){ showToast('Index/Interval required'); return; }
  tasEntries.push({ index:idx, interval:iv, gateStates:gs });
  tasEntries.sort((a,b)=>a.index-b.index);
  refreshTasList(); saveAuto();
});
$('clearTas').addEventListener('click', ()=>{ tasEntries.length=0; refreshTasList(); $('tasOut').textContent=''; saveAuto(); });

$('genTas').addEventListener('click', ()=>{
  const ifn=$('tasIfName').value||'1';
  const ops=[];
  // gate-enabled
  ops.push({ path:`/ietf-interfaces:interfaces/interface[name='${ifn}']/ieee802-dot1q-bridge:bridge-port/ieee802-dot1q-sched-bridge:gate-parameter-table/gate-enabled`, value:true });
  // admin-control-list
  tasEntries.forEach(e=>{
    ops.push({ path:`/ietf-interfaces:interfaces/interface[name='${ifn}']/ieee802-dot1q-bridge:bridge-port/ieee802-dot1q-sched-bridge:gate-parameter-table/admin-control-list/gate-control-entry`,
      value:{ index:e.index, 'operation-name':'ieee802-dot1q-sched:set-gate-states', 'time-interval-value':e.interval, 'gate-states-value': e.gateStates }});
  });
  // base/cycle
  ops.push({ path:`/ietf-interfaces:interfaces/interface[name='${ifn}']/ieee802-dot1q-bridge:bridge-port/ieee802-dot1q-sched-bridge:gate-parameter-table/admin-base-time/seconds`, value: String(+$('tasBaseSec').value|0) });
  ops.push({ path:`/ietf-interfaces:interfaces/interface[name='${ifn}']/ieee802-dot1q-bridge:bridge-port/ieee802-dot1q-sched-bridge:gate-parameter-table/admin-base-time/nanoseconds`, value: +$('tasBaseNsec').value|0 });
  ops.push({ path:`/ietf-interfaces:interfaces/interface[name='${ifn}']/ieee802-dot1q-bridge:bridge-port/ieee802-dot1q-sched-bridge:gate-parameter-table/admin-cycle-time/numerator`, value: +$('tasCycleNum').value|0 });
  ops.push({ path:`/ietf-interfaces:interfaces/interface[name='${ifn}']/ieee802-dot1q-bridge:bridge-port/ieee802-dot1q-sched-bridge:gate-parameter-table/admin-cycle-time/denominator`, value: +$('tasCycleDen').value|0 });
  ops.push({ path:`/ietf-interfaces:interfaces/interface[name='${ifn}']/ieee802-dot1q-bridge:bridge-port/ieee802-dot1q-sched-bridge:gate-parameter-table/admin-cycle-time-extension`, value: +$('tasCycleExt').value|0 });
  // config-change
  ops.push({ path:`/ietf-interfaces:interfaces/interface[name='${ifn}']/ieee802-dot1q-bridge:bridge-port/ieee802-dot1q-sched-bridge:gate-parameter-table/config-change`, value:true });

  $('tasOut').textContent = JSON.stringify({ iPATCH: ops }, null, 2);
  validateTas();
  saveAuto();
});
$('copyTas').addEventListener('click', ()=>copyText($('tasOut').textContent));

function validateTas(){
  const sum = tasEntries.reduce((a,b)=>a+b.interval,0);
  const num = +$('tasCycleNum').value|0, den = +$('tasCycleDen').value|1;
  const cycNs = Math.floor(num/(den||1));
  if(sum > cycNs){ showToast('⚠️ Intervals exceed cycle time'); }
}

/* TAS canvas drawing */
function drawTas(){
  const cv = $('tasCanvas'); const ctx = cv.getContext('2d');
  const W = cv.clientWidth||400, H = cv.clientHeight||120;
  cv.width = W; cv.height = H;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#111'; ctx.fillRect(0,0,W,H);
  // axis
  ctx.strokeStyle='#333'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(10,H-20); ctx.lineTo(W-10,H-20); ctx.stroke();
  const total = tasEntries.reduce((a,b)=>a+b.interval,0) || 1;
  let x=10;
  tasEntries.forEach((e,i)=>{
    const w = (W-20)*(e.interval/total);
    ctx.fillStyle = '#19c37d'; ctx.globalAlpha = .8; ctx.fillRect(x, 20, w, H-40);
    ctx.globalAlpha=1; ctx.fillStyle='#fff'; ctx.font='12px ui-monospace';
    ctx.fillText(`#${e.index} gs=${e.gateStates}`, x+6, 36);
    ctx.fillText(`${e.interval}ns`, x+6, 52);
    x += w;
  });
}

/* PSFP */
$('genPsfp').addEventListener('click', ()=>{
  const sId=+$('psfpStreamId').value|0, handle=+$('psfpHandle').value|0, inPort=$('psfpInPort').value||'1', dmac=$('psfpDmac').value||'01-02-03-04-05-06';
  const fId=+$('psfpFilterId').value|0, maxSdu=+$('psfpMaxSdu').value|0, gRef=+$('psfpGateRef').value|0, mRef=+$('psfpMeterRef').value|0;

  const ops=[];
  ops.push({ path:"/ieee802-dot1cb-stream-identification:stream-identity", value:{ index:sId, handle, 'out-facing':{ 'input-port':[String(inPort)]}, 'null-stream-identification':{ 'destination-mac': dmac }}});
  ops.push({ path:"/ieee802-dot1q-bridge:bridges/bridge[name='b0']/component[name='c0']/ieee802-dot1q-psfp-bridge:stream-filters/stream-filter-instance-table",
    value:{ 'stream-filter-instance-id': fId, 'stream-handle': handle, 'priority-spec':'wildcard', 'max-sdu-size': maxSdu, 'stream-gate-ref': gRef, 'flow-meter-ref': mRef }});
  ops.push({ path:"/ieee802-dot1q-bridge:bridges/bridge[name='b0']/component[name='c0']/ieee802-dot1q-psfp-bridge:stream-gates/stream-gate-instance-table",
    value:{ 'stream-gate-instance-id': gRef, 'gate-enable': true, 'admin-gate-states':'open', 'admin-cycle-time':{ 'numerator':1,'denominator':5000 }, 'admin-base-time':{} } });

  $('psfpOut').textContent = JSON.stringify({ iPATCH: ops }, null, 2);
  saveAuto();
});
$('copyPsfp').addEventListener('click', ()=>copyText($('psfpOut').textContent));

function copyText(t){ if(!t) return; navigator.clipboard?.writeText(t).then(()=>showToast('Copied')); }

/* =========================
   Profiles (localStorage)
   ========================= */
$('toggleProfiles').addEventListener('click', ()=> $('profileDrawer').classList.toggle('visible'));

const LS_KEY = 'tsn_viewer_profiles_v1';
const LS_LAST = 'tsn_viewer_last_v1';

function getProfiles(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(e){ return {}; } }
function setProfiles(p){ localStorage.setItem(LS_KEY, JSON.stringify(p)); }
function getLast(){ try{ return JSON.parse(localStorage.getItem(LS_LAST)||'{}'); }catch(e){ return {}; } }
function setLast(o){ localStorage.setItem(LS_LAST, JSON.stringify(o)); }

function getState(){
  const nodes = tsnGroup.children.map(c=>({ label:c.userData.label||'', device:c.userData.device||'', type:c.userData.tsnType||'', pos:c.position.toArray() }));
  const ptp = $('ptpOut').textContent ? JSON.parse($('ptpOut').textContent) : null;
  const tas = $('tasOut').textContent ? JSON.parse($('tasOut').textContent) : null;
  const psfp= $('psfpOut').textContent ? JSON.parse($('psfpOut').textContent) : null;
  const opacity = parseFloat($('opacitySlider').value||'1');
  return {
    model: $('modelName').textContent||'',
    tsnVisible, nodes, ptp, tas, psfp,
    tasEntries, tasParams:{
      ifName:$('tasIfName').value, baseSec:+$('tasBaseSec').value|0, baseNsec:+$('tasBaseNsec').value|0,
      cycleNum:+$('tasCycleNum').value|0, cycleDen:+$('tasCycleDen').value|1, cycleExt:+$('tasCycleExt').value|0
    },
    ptpParams:{
      profile:$('ptpProfile').value, servo:$('ptpServo').value, instance:+$('ptpInstance').value|0, ltc:+$('ptpLtc').value|0, portA:+$('ptpPortA').value|0, portB:+$('ptpPortB').value|0
    },
    psfpParams:{
      streamId:+$('psfpStreamId').value|0, handle:+$('psfpHandle').value|0, inPort:$('psfpInPort').value, dmac:$('psfpDmac').value,
      filterId:+$('psfpFilterId').value|0, maxSdu:+$('psfpMaxSdu').value|0, gateRef:+$('psfpGateRef').value|0, meterRef:+$('psfpMeterRef').value|0
    },
    opacity, xrayOn
  };
}

function applyState(st){
  if(!st) return;
  tsnVisible = !!st.tsnVisible; tsnGroup.visible = tsnVisible; $('toggleTSN').classList.toggle('active', tsnVisible); $('toggleTSN').textContent = tsnVisible ? 'Hide TSN' : 'Show TSN';
  tsnGroup.clear();
  (st.nodes||[]).forEach(n=>{
    let obj=null;
    if(n.type==='board'){ obj = createTSNBoard(n.device==='LAN9692'?0x00C853:0x0066FF, n.label||'',2.5); obj.userData.device = n.device||''; }
    else if(n.type==='sensor'){ obj = createSensor(0x00BCD4, 2); obj.userData.label=n.label||''; }
    else if(n.type==='overlay'){ /* ignore reconstruct overlay */ }
    if(obj){ obj.position.fromArray(n.pos||[0,0,0]); tsnGroup.add(obj); }
  });
  updateConnections(); renderSwitchCards();

  // PTP
  if(st.ptpParams){
    $('ptpProfile').value = st.ptpParams.profile||'gptp';
    $('ptpServo').value   = st.ptpParams.servo||'pi';
    $('ptpInstance').value= st.ptpParams.instance||0;
    $('ptpLtc').value     = st.ptpParams.ltc||0;
    $('ptpPortA').value   = st.ptpParams.portA||25;
    $('ptpPortB').value   = st.ptpParams.portB||26;
  }
  if(st.ptp) $('ptpOut').textContent = JSON.stringify(st.ptp, null, 2);

  // TAS
  tasEntries.length=0; (st.tasEntries||[]).forEach(e=>tasEntries.push(e)); refreshTasList();
  if(st.tasParams){
    $('tasIfName').value = st.tasParams.ifName||'1';
    $('tasBaseSec').value= st.tasParams.baseSec||20;
    $('tasBaseNsec').value= st.tasParams.baseNsec||0;
    $('tasCycleNum').value= st.tasParams.cycleNum||140000000;
    $('tasCycleDen').value= st.tasParams.cycleDen||1000000000;
    $('tasCycleExt').value= st.tasParams.cycleExt||10000000;
  }
  if(st.tas) $('tasOut').textContent = JSON.stringify(st.tas, null, 2);

  // PSFP
  if(st.psfpParams){
    $('psfpStreamId').value = st.psfpParams.streamId||1;
    $('psfpHandle').value   = st.psfpParams.handle||2;
    $('psfpInPort').value   = st.psfpParams.inPort||'1';
    $('psfpDmac').value     = st.psfpParams.dmac||'01-02-03-04-05-06';
    $('psfpFilterId').value = st.psfpParams.filterId||1;
    $('psfpMaxSdu').value   = st.psfpParams.maxSdu||1024;
    $('psfpGateRef').value  = st.psfpParams.gateRef||1;
    $('psfpMeterRef').value = st.psfpParams.meterRef||1;
  }
  if(st.psfp) $('psfpOut').textContent = JSON.stringify(st.psfp, null, 2);

  // opacity/xray
  $('opacitySlider').value = st.opacity!=null? st.opacity : 1;
  if(st.xrayOn){ xrayOn=true; $('xrayBtn').classList.add('active'); setModelOpacity(0.3,true); }
  else{ setModelOpacity(st.opacity!=null? st.opacity : 1, false); }
}

function saveProfile(name){
  if(!name){ name = prompt('Profile name?'); if(!name) return; }
  const profiles = getProfiles(); profiles[name] = getState(); setProfiles(profiles);
  setLast({ lastProfile:name }); fillProfileSelect(name); showToast(`Saved: ${name}`);
  $('profilePreview').textContent = JSON.stringify(profiles[name], null, 2);
}
function saveAuto(){ const last = getLast(); if(last.lastProfile){ const p = getProfiles(); p[last.lastProfile] = getState(); setProfiles(p); } setLast({ ...last, lastState:getState() }); }
function loadProfile(name){
  const profiles = getProfiles(); const st = profiles[name]; if(!st){ showToast('Profile not found'); return; }
  applyState(st); setLast({ lastProfile:name, lastState:st }); $('profilePreview').textContent = JSON.stringify(st, null, 2);
}
function deleteProfile(name){
  const p = getProfiles(); if(!(name in p)) return; delete p[name]; setProfiles(p); fillProfileSelect(); setLast({}); $('profilePreview').textContent=''; showToast('Deleted');
}
function fillProfileSelect(selectName){
  const sel = $('profileSelect'); const p = getProfiles(); const names = Object.keys(p);
  sel.innerHTML = names.length? names.map(n=>`<option>${n}</option>`).join('') : `<option value="">(no profiles)</option>`;
  if(selectName && names.includes(selectName)) sel.value = selectName;
  sel.onchange = ()=> loadProfile(sel.value);
}
$('saveProfile').addEventListener('click', ()=>{ const sel=$('profileSelect'); const name = sel.value || prompt('Profile name?'); if(name) saveProfile(name); });
$('saveAsProfile').addEventListener('click', ()=> saveProfile(prompt('New profile name?')));
$('deleteProfile').addEventListener('click', ()=>{ const name=$('profileSelect').value; if(name && confirm(`Delete "${name}"?`)) deleteProfile(name); });

$('exportProfile').addEventListener('click', ()=>{
  const sel=$('profileSelect').value; const p=getProfiles(); const data = sel? p[sel] : getState();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = (sel||'tsn_profile')+'.json'; a.click(); URL.revokeObjectURL(url);
});
$('importFile').addEventListener('change', (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload = ()=>{
    try{ const st = JSON.parse(r.result); applyState(st); $('profilePreview').textContent = JSON.stringify(st,null,2); showToast('Imported'); }
    catch(err){ alert('Invalid JSON'); }
  }; r.readAsText(f);
});

function loadState(){ const last = getLast(); return last.lastState || null; }

/* init profile UI */
fillProfileSelect();
const last = getLast();
if(last.lastProfile){ fillProfileSelect(last.lastProfile); loadProfile(last.lastProfile); }
else { const st = loadState(); if(st) applyState(st); }

/* =========================
   Animation Loop
   ========================= */
function animate(){
  requestAnimationFrame(animate);
  controls.update();
  tsnGroup.children.forEach((child,i)=>{
    if(child.children && child.children.length){
      const glow = child.children.find(c=>c.material && c.material.opacity<1);
      if(glow){ glow.rotation.y += 0.02; glow.material.opacity = 0.3 + Math.sin(Date.now()*0.002 + i)*0.2; }
    }
  });
  renderer.render(scene, camera);
}
animate();

</script>
</body>
</html>
